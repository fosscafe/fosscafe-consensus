<!DOCTYPE html>
<html><head>
<title>Paxos Made Moderately Complex</title>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="static/main.css" type="text/css" rel="stylesheet">
<link href="static/pygments.css" type="text/css" rel="stylesheet">
<link rel="icon" type="image/png" href="static/favicon.png">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js"></script>

<!-- Google Analytics -->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

     ga('create', 'UA-55641322-1', 'auto');
     ga('send', 'pageview');

    </script>
<!---------------------->
</head><body>
<img class="logo" src="static/logo.png" title="Paxos Made Moderately Complex" width=180>
<div class="grid">
<!-- ===================================== END HEADER ===================================== -->
<a href="https://github.com/denizalti/paxosmmc" id="github-logo" target="_blank" ><img src="static/github.gif" width="55"></a>

<nav class="navbar">
  <ul>
    <li><a href="index.html">Paxos</a></li>
    <li><a href="why.html">Why?</a></li>
    <li><a href="how.html">How?</a>
      <ul>
	<li><a href="replica.html">Replicas</a></li>
	<li><a href="acceptor.html">Acceptors</a></li>
	<li><a href="leader.html">Leaders</a></li>
      </ul>
    </li>
    <li><a href="when.html">When?</a></li>
    <li><a href="variants.html">Variants</a></li>
    <li><a href="code.html" style="color:white;">Code</a></li>
    <li><a href="glossary.html">Glossary</a></li>
    <li><a href="about.html">About</a></li>
    <li><a href="links.html">Links</a></li>
  </ul>
</nav>
<div id="main">

<p>The Python source code corresponding to the pseudo-code we
present in this website is available in the following git repository:
</p>
<ul>
<a href="https://github.com/denizalti/paxosmmc" target="_blank"><img src="static/GitHub-Mark-120px-plus.png" width="25"></a>
<a href="https://github.com/denizalti/paxosmmc" target="_blank">https://github.com/denizalti/paxosmmc</a>
</ul>

<p>You can clone the repo as follows:</p>
<pre>$ git clone https://github.com/denizalti/paxosmmc.git</pre>

<p>
The source code includes the <a href="#replica">
Replica</a>, <a href="#acceptor">Acceptor</a>,
<a href="#commander">Commander</a>, <a href="#scout">Scout</a>
and <a href="#leader">Leader</a> codes as well
as <a href="#utilities">Utilities</a>,
<a href="#message">Message</a>,
<a href="#process">Process</a>
and <a href="#environment">Environment</a> codes that implement the
functionality to run the processes.</p>


<a name="replica"><h1>Replica</h1></a>
<p>
 A <b>replica</b> runs in an infinite loop, receiving messages.
Replicas receive two kinds of messages: requests and decisions.  When
it receives a request for command <span class="cursive">c</span> from a client, the
replica adds the request to set <span class="mono">requests</span>.
Next, the replica invokes the function <span class="mono">propose()</span>.
</p>
<p>
Function <span class="mono">propose()</span> tries to transfer requests from the
set <span class="mono">requests</span> to <span class="mono">proposals</span>. It uses <span class="mono">slot_in</span>
to look for unused slots within the window of slots with known
configurations. For each such slot <span class="mono">s</span>, it first checks if
the configuration for <span class="mono">s</span> is different from the prior slot by
checking if the decision in slot <span class="mono">s−WINDOW</span> is a
reconfiguration command. If so, the function updates the set of
leaders for slot <span class="mono">s</span>. Then the function removes a
request <span class="mono">r</span> from <span class="mono">requests</span> and adds proposal
<span class="mono">(s,r)</span> to the set <span class="mono">proposals</span>. Finally, it
sends a <span class="mono">⟨<b>propose</b>, s, c⟩</span> message to all leaders in the
configuration of slot <span class="mono">s</span>.
</p>
<p>
Decisions may arrive out-of-order and multiple times. For each
<b>decision</b> message, the replica adds the decision to the set
<span class="mono">decisions</span>. Then, in a loop, it considers
which decisions are ready for execution before trying to receive more
messages. If there is a decision <span class="cursive">c'</span>
corresponding to the current </span>slot_out</span>, the replica first
checks to see if it has proposed a
command <span class="cursive">c''</span> for that slot. If so, the
replica
removes <span class="mono">⟨slot_out</span>,<span class="cursive">c''</span><span class="mono">⟩</span>
from the
set <span class="mono">proposals</span>. If <span class="cursive">c''&ne;
c'</span>, that is, the replica proposed a different command for that
slot, the replica returns <span class="cursive">c''</span> to
set <span class="mono">requests</span>
so <span class="cursive">c''</span> is proposed again at a later
time. Next, the replica
invokes <span class="mono">perform(</span><span class="cursive">c'</span><span class="mono">)</span>.
</p>
<p>
The function <span class="mono">perform()</span> is invoked with the same sequence of
commands at all replicas. First, it checks to see if it has already
performed the command. Different replicas may end up proposing the
same command for different slots, and thus the same command may be
decided multiple times. The corresponding operation is evaluated only
if the command is new and it is not a reconfiguration request. If so,
<span class="mono">perform()</span> applies the requested operation to the application state. In
either case, the function increments <span class="mono">slot_out</span>.
</p>

<div class="highlight"><pre><span class="kn">from</span> <span class="nn">process</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">message</span> <span class="kn">import</span> <span class="n">ProposeMessage</span><span class="p">,</span><span class="n">DecisionMessage</span><span class="p">,</span><span class="n">RequestMessage</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Replica</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">Process</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">slot_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">proposals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">decisions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">addProc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">propose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot_in</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span><span class="o">+</span><span class="n">WINDOW</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot_in</span> <span class="o">&gt;</span> <span class="n">WINDOW</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot_in</span><span class="o">-</span><span class="n">WINDOW</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decisions</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decisions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_in</span><span class="o">-</span><span class="n">WINDOW</span><span class="p">],</span><span class="n">ReconfigCommand</span><span class="p">):</span>
          <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decisions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_in</span><span class="o">-</span><span class="n">WINDOW</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">),</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">),</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
          <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;: new config:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot_in</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decisions</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proposals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_in</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="k">for</span> <span class="n">ldr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">leaders</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">ldr</span><span class="p">,</span> <span class="n">ProposeMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_in</span><span class="p">,</span><span class="n">cmd</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">slot_in</span> <span class="o">+=</span><span class="mi">1</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">decisions</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">ReconfigCommand</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">return</span>
    <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;: perform&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="n">cmd</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span> <span class="o">+=</span> <span class="mi">1</span>

  <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;Here I am: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNextMessage</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">RequestMessage</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">DecisionMessage</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decisions</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">slot_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">command</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">decisions</span><span class="p">:</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposals</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span><span class="p">]</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">decisions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span><span class="p">]:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proposals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span><span class="p">])</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span><span class="p">]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">perform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decisions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_out</span><span class="p">])</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Replica: unknown msg type&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">propose</span><span class="p">()</span>
</pre></div>

<a name="acceptor"><h1>Acceptor</h1></a>
<p>
An <b>acceptor</b> runs
in an infinite loop, receiving two kinds of request messages from
leaders:
<ul>
<li><span class="mono">P1aMessage</span>: Upon receiving a &#8220;Phase 1a&#8221;
  request message from a leader for a ballot number, an acceptor makes
  the following transition. First, the acceptor
  adopts <span class="mono">msg.ballot_number</span> if and only if it exceeds its
  current ballot number. Then it returns to the leader a &#8220;Phase
  1b&#8221; response message containing its current ballot number and
  all pvalues accepted thus far by the acceptor.
</li>
<li><span class="mono">P2aMessage</span>: Upon receiving a &#8220;Phase 2a&#8221;
  request message from a leader with a pvalue, an acceptor makes the
  following transition.  If <span class="mono">msg.ballot_number</span> equals the
  current ballot number, then the acceptor accepts the pvalue.  The
  acceptor returns to the leader a &#8220;Phase 2b&#8221; response
  message containing its current ballot number.
</li>
</ul>
</p>

<div class="highlight"><pre><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">PValue</span>
<span class="kn">from</span> <span class="nn">process</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">message</span> <span class="kn">import</span> <span class="n">P1aMessage</span><span class="p">,</span> <span class="n">P1bMessage</span><span class="p">,</span> <span class="n">P2aMessage</span><span class="p">,</span> <span class="n">P2bMessage</span>

<span class="k">class</span> <span class="nc">Acceptor</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">id</span><span class="p">):</span>
    <span class="n">Process</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">addProc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;Here I am: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNextMessage</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">P1aMessage</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">ballot_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
                         <span class="n">P1bMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span><span class="p">))</span>
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">P2aMessage</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">PValue</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">,</span>
                                   <span class="n">msg</span><span class="o">.</span><span class="n">slot_number</span><span class="p">,</span>
                                   <span class="n">msg</span><span class="o">.</span><span class="n">command</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
                         <span class="n">P2bMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">,</span>
                                    <span class="n">msg</span><span class="o">.</span><span class="n">slot_number</span><span class="p">))</span>
</pre></div>

<a name="commander"><h1>Commander</h1></a>

<div class="highlight"><pre><span class="kn">from</span> <span class="nn">message</span> <span class="kn">import</span> <span class="n">P2aMessage</span><span class="p">,</span> <span class="n">P2bMessage</span><span class="p">,</span> <span class="n">PreemptedMessage</span><span class="p">,</span> <span class="n">DecisionMessage</span>
<span class="kn">from</span> <span class="nn">process</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">Command</span>

<span class="k">class</span> <span class="nc">Commander</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">leader</span><span class="p">,</span> <span class="n">acceptors</span><span class="p">,</span> <span class="n">replicas</span><span class="p">,</span>
               <span class="n">ballot_number</span><span class="p">,</span> <span class="n">slot_number</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
    <span class="n">Process</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="n">leader</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span> <span class="o">=</span> <span class="n">acceptors</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">replicas</span> <span class="o">=</span> <span class="n">replicas</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">=</span> <span class="n">ballot_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">slot_number</span> <span class="o">=</span> <span class="n">slot_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">addProc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">waitfor</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">P2aMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">slot_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">))</span>
      <span class="n">waitfor</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNextMessage</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">P2bMessage</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">==</span> <span class="n">msg</span><span class="o">.</span><span class="n">ballot_number</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">src</span> <span class="ow">in</span> <span class="n">waitfor</span><span class="p">:</span>
          <span class="n">waitfor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">waitfor</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicas</span><span class="p">:</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">DecisionMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">slot_number</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leader</span><span class="p">,</span> <span class="n">PreemptedMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">))</span>
          <span class="k">return</span>
</pre></div>

<a name="scout"><h1>Scout</h1></a>

<div class="highlight"><pre><span class="kn">from</span> <span class="nn">process</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">message</span> <span class="kn">import</span> <span class="n">P1aMessage</span><span class="p">,</span> <span class="n">P1bMessage</span><span class="p">,</span> <span class="n">PreemptedMessage</span><span class="p">,</span> <span class="n">AdoptedMessage</span>

<span class="k">class</span> <span class="nc">Scout</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">leader</span><span class="p">,</span> <span class="n">acceptors</span><span class="p">,</span> <span class="n">ballot_number</span><span class="p">):</span>
    <span class="n">Process</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">leader</span> <span class="o">=</span> <span class="n">leader</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span> <span class="o">=</span> <span class="n">acceptors</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">=</span> <span class="n">ballot_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">addProc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">waitfor</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">P1aMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">))</span>
      <span class="n">waitfor</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="n">pvalues</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNextMessage</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">P1bMessage</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">==</span> <span class="n">msg</span><span class="o">.</span><span class="n">ballot_number</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">src</span> <span class="ow">in</span> <span class="n">waitfor</span><span class="p">:</span>
          <span class="n">pvalues</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">accepted</span><span class="p">)</span>
          <span class="n">waitfor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">waitfor</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leader</span><span class="p">,</span>
                             <span class="n">AdoptedMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">,</span>
                                            <span class="n">pvalues</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leader</span><span class="p">,</span>
                           <span class="n">PreemptedMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                            <span class="n">msg</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">))</span>
          <span class="k">return</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Scout: unexpected msg&quot;</span>
</pre></div>

<a name="leader"><h1>Leader</h1></a>

<div class="highlight"><pre><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">BallotNumber</span>
<span class="kn">from</span> <span class="nn">process</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">commander</span> <span class="kn">import</span> <span class="n">Commander</span>
<span class="kn">from</span> <span class="nn">scout</span> <span class="kn">import</span> <span class="n">Scout</span>
<span class="kn">from</span> <span class="nn">message</span> <span class="kn">import</span> <span class="n">ProposeMessage</span><span class="p">,</span><span class="n">AdoptedMessage</span><span class="p">,</span><span class="n">PreemptedMessage</span>

<span class="k">class</span> <span class="nc">Leader</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">Process</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">=</span> <span class="n">BallotNumber</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">proposals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">addProc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;Here I am: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
    <span class="n">Scout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;scout:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">)),</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">acceptors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNextMessage</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ProposeMessage</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">slot_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposals</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">proposals</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">slot_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">command</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="n">Commander</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
                      <span class="s">&quot;commander:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                                              <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">),</span>
                                              <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">slot_number</span><span class="p">)),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">acceptors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">replicas</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">slot_number</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>

      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">AdoptedMessage</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">==</span> <span class="n">msg</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">:</span>
          <span class="n">pmax</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">accepted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">slot_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pmax</span> <span class="ow">or</span> \
                  <span class="n">pmax</span><span class="p">[</span><span class="n">pv</span><span class="o">.</span><span class="n">slot_number</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pv</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">:</span>
              <span class="n">pmax</span><span class="p">[</span><span class="n">pv</span><span class="o">.</span><span class="n">slot_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">ballot_number</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">proposals</span><span class="p">[</span><span class="n">pv</span><span class="o">.</span><span class="n">slot_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">command</span>
          <span class="k">for</span> <span class="n">sn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposals</span><span class="p">:</span>
            <span class="n">Commander</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
                      <span class="s">&quot;commander:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                                              <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">),</span>
                                              <span class="nb">str</span><span class="p">(</span><span class="n">sn</span><span class="p">)),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">acceptors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">replicas</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">,</span> <span class="n">sn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sn</span><span class="p">))</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">PreemptedMessage</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">=</span> <span class="n">BallotNumber</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">ballot_number</span><span class="o">.</span><span class="n">round</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
          <span class="n">Scout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;scout:</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                                           <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">acceptors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Leader: unknown msg type&quot;</span>
</pre></div>

<a name="environment"><h1>Environment</h1></a>
<p>
This is the main code in which all processes are created and run.
This code also simulates a set of clients submitting requests.
</p>

<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">signal</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">acceptor</span> <span class="kn">import</span> <span class="n">Acceptor</span>
<span class="kn">from</span> <span class="nn">leader</span> <span class="kn">import</span> <span class="n">Leader</span>
<span class="kn">from</span> <span class="nn">message</span> <span class="kn">import</span> <span class="n">RequestMessage</span>
<span class="kn">from</span> <span class="nn">process</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">replica</span> <span class="kn">import</span> <span class="n">Replica</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">NACCEPTORS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">NREPLICAS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">NLEADERS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">NREQUESTS</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">NCONFIGS</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">class</span> <span class="nc">Env</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">def</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">deliver</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">addProc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[</span><span class="n">proc</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">proc</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">removeProc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">initialconfig</span> <span class="o">=</span> <span class="n">Config</span><span class="p">([],</span> <span class="p">[],</span> <span class="p">[])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NREPLICAS</span><span class="p">):</span>
      <span class="n">pid</span> <span class="o">=</span> <span class="s">&quot;replica: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span>
      <span class="n">Replica</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">initialconfig</span><span class="p">)</span>
      <span class="n">initialconfig</span><span class="o">.</span><span class="n">replicas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NACCEPTORS</span><span class="p">):</span>
      <span class="n">pid</span> <span class="o">=</span> <span class="s">&quot;acceptor: </span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
      <span class="n">Acceptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
      <span class="n">initialconfig</span><span class="o">.</span><span class="n">acceptors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLEADERS</span><span class="p">):</span>
      <span class="n">pid</span> <span class="o">=</span> <span class="s">&quot;leader: </span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
      <span class="n">Leader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">initialconfig</span><span class="p">)</span>
      <span class="n">initialconfig</span><span class="o">.</span><span class="n">leaders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class class="n">r</span> <span class="ow">in</span> <span class="n">initialconfig</span><span class="o">.</span><span class="n">replicas</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;operation </span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</e</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NCONFIGS</span><span class="p">):</span>
      <span class="c"># Create new configuration</span>
      <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">initialconfig</span><span class="o">.</span><span class="n">replicas</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[])</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NACCEPTORS</span><span class="p">):</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="s">&quot;acceptor: </span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">Acceptor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">acceptors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NLEADERS</span><span class="p">):</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="s">&quot;leader: </span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">Leader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">leaders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
      <span class="c"># Send reconfiguration request</span>
      <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">replicas</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="s">&quot;master: </span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">ReconfigCommand</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">RequestMessage</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">WINDOW</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="s">&quot;master: </span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">replicas</span><span class="p">:</span>
          <span class="n">cmd</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;operation noop&quot;</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">RequestMessage</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
          <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NREQUESTS</span><span class="p">):</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="s">&quot;client: </span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span>config</span><span class="o">.</span><span class="n">replicas</span><span class="p">:</span>
          <span class="n">cmd</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><spaspan class="p">(</span><span class="mi">1</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">terminate_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_graceexit</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_graceexit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exitcode</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="n">exitcode</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="n">e</span> <span class="o">=</span> <span class="n">Env</span><span class="p">()</span>
  <span class="n">e</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
  <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">terminate_handler</span><span class="p">)</span>
  <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">terminate_handler</span><span class="p">)</span>
  <span class="n">signal</span><span class="o">.</span><span class="n">pause</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">main</span><span class="p">()</span>
</pre></div>


<a name="process"><h1>Process</h1></a>
<p>
A <b>process</b> is a thread with a process identifier, a queue of incoming
messages, and an &#8220;environment&#8221; that keeps track of all processes and
queues.
</p>

<div class="highlight"><pre><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="k">class</span> <span class="nc">Process</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inbox</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>

  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">removeProc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;Exiting..&quot;</span>

  <span class="k">def</span> <span class="nf">getNextMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inbox</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">sendMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">deliver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inbox</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>

<a name="message"><h1>Message</h1></a>
<p>
Paxos uses a large variety of message types.  They are collected
below.
</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Message</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">src</span>

  <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">P1aMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ballot_number</span><span class="p">):</span>
    <span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">=</span> <span class="n">ballot_number</span>

<span class="k">class</span> <span class="nc">P1bMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ballot_number</span><span class="p">,</span> <span class="n">accepted</span><span class="p">):</span>
    <span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">=</span> <span class="n">ballot_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span> <span class="o">=</span> <span class="n">accepted</span>

<span class="k">class</span> <span class="nc">P2aMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ballot_number</span><span class="p">,</span> <span class="n">slot_number</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
    <span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">=</span> <span class="n">ballot_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">slot_number</span> <span class="o">=</span> <span class="n">slot_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>

<span class="k">class</span> <span class="nc">P2bMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ballot_number</span><span class="p">,</span> <span class="n">slot_number</span><span class="p">):</span>
    <span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">=</span> <span class="n">ballot_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">slot_number</span> <span class="o">=</span> <span class="n">slot_number</span>

<span class="k">class</span> <span class="nc">PreemptedMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ballot_number</span><span class="p">):</span>
    <span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">=</span> <span class="n">ballot_number</span>

<span class="k">class</span> <span class="nc">AdoptedMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ballot_number</span><span class="p">,</span> <span class="n">accepted</span><span class="p">):</span>
    <span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span> <span class="o">=</span> <span class="n">ballot_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span> <span class="o">=</span> <span class="n">accepted</span>

<span class="k">class</span> <span class="nc">DecisionMessage</span><span class="p">(</span><span clan class="o">=</span> <span class="n">slot_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>

<span class="k">class</span> <span class="nc">RequestMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
    <span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>

<span class="k">class</span> <span class="nc">ProposeMessage</span><span class="p">(</span><span class="n">Message</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">slot_number</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
    <span class="n">Message</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">slot_number</span> <span class="o">=</span> <span class="n">slot_number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
</pre></div>

<a name="utilities"><h1>Utilities</h1></a>

<p>
A <b>ballot number</b> is a lexicographically ordered pair of an integer and
the identifier of the ballot's leader.
<br>
A <b>pvalue</b> consists of a ballot number, a slot number, and a command.
<br>
A <b>command</b> consists of the process identifier of the client submitting
the request, a client-local request identifier, and an operation
(which can be anything).
<br>
A <b>reconfiguration command</b> consists of the process identifier of the
client submitting the request, a client-local request identifier, and
a configuration.
<br>
A <b>configuration</b> consists of a list of replicas, a list of acceptors
and a list of leaders.
</p>

<div class="highlight"><pre><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="n">WINDOW</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">class</span> <span class="nc">BallotNumber</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;BallotNumber&#39;</span><span class="p">,[</span><span class="s">&#39;round&#39;</span><span class="p">,</span><span class="s">&#39;leader_id&#39;</span><span class="p">])):</span>
  <span class="n">__slots__</span> <span class="o">=</span> <span class="p">()</span>
  <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;BN(</span><span class="si">%d</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">leader_id</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">PValue</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;PValue&#39;</span><span class="p">,[</span><span class="s">&#39;ballot_number&#39;</span><span class="p">,</span><span class="s">&#39;slot_number&#39;</span><span class="p">,</span><span class="s">&#39;command&#39;</span><span class="p">])):</span>
  <span class="n">__slots__</span> <span class="o">=</span> <span class="p">()</span>
  <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;PV(</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ballot_number</span><span class="p">),</span>
                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_number</span><span class="p">),</span>
                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;Command&#39;</span><span class="p">,[</span><span class="s">&#39;client&#39;</span><span class="p">,</span><span class="s">&#39;req_id&#39;</span><span class="p">,</span><span class="s">&#39;op&#39;</span><span class="p">])):</span>
  <span class="n">__slots__</span> <span class="o">=</span> <span class="p">()</span>
  <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;Command(</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">),</span>
                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_id</span><span class="p">),</span>
                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">ReconfigCommand</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;ReconfigCommand&#39;</span><span class="p">,[</span><span class="s">&#39;client&#39;</span><span class="p">,</span><span class="s">&#39;req_id&#39;</span><span class="p">,</span><span class="s">&#39;config&#39;</span><span class="p">])):</span>
  <span class="n">__slots__</span> <span class="o">=</span> <span class="p">()</span>
  <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;ReconfigCommand(</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">),</span>
                                          <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req_id</span><span class="p">),</span>
                                          <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;Config&#39;</span><span class="p">,[</span><span class="s">&#39;replicas&#39;</span><span class="p">,</span><span class="s">&#39;acceptors&#39;</span><span class="p">,</span><span class="s">&#39;leaders&#39;</span><span class="p">])):</span>
  <span class="n">__slots__</span> <span class="o">=</span> <spalass="p">()</span>
  <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">;</span><span class="si">%s</span><span class="s">;</span><span clan class="bp">self</span><span class="o">.</span><span class="n">leaders</span><span class="p">))</span>
</pre></div>


</div>

<!-- ===================================== START FOOTER ===================================== -->
<div class="clear"></div>
<div id="footer">
  <a href="http://www.cs.cornell.edu/">Computer Science Department</a><br>
  <a href="http://www.cornell.edu/">Cornell University</a>
</div>

</body></html>
